name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      globals: ${{ steps.filter.outputs.globals }}
      scripts: ${{ steps.filter.outputs.scripts }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            globals:
              - 'globals.sh'
              - 'tests/test-globals.bats'
              - 'tests/run-tests.sh'
            scripts:
              - 'scripts/ops-update-symlinks.sh'
              - 'scripts/cfg-dev-tools-proxy.sh'
              - 'scripts/cfg-default-dirs.sh'
              - 'env/include-paths.sh'
              - 'env/env-vars.sh'
              - '.profile'
              - 'helpers/ls-path'
              - 'tests/test-scripts.bats'
              - 'tests/run-tests.sh'

  test-globals:
    needs: changes
    if: needs.changes.outputs.globals == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install bats
        run: sudo apt-get update -qq && sudo apt-get install -y bats
      - name: Run globals tests
        run: ./tests/run-tests.sh globals

  test-scripts:
    needs: changes
    if: needs.changes.outputs.scripts == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install bats
        run: sudo apt-get update -qq && sudo apt-get install -y bats
      - name: Run script tests
        run: ./tests/run-tests.sh scripts
